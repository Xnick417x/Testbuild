name: Build VKD3D-Proton (Standard + Complete ARM Fix)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *"

jobs:
  # ==================================================================
  # JOB 1: STANDARD BUILD (LOCKED & UNTOUCHED)
  # ==================================================================
  build-standard:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl xz-utils jq git glslang-tools \
            build-essential python3 python3-pip pkg-config \
            meson ninja-build zstd

      - name: Setup Toolchain
        run: |
          LLVM_MINGW_TAG="20251104"
          TOOLCHAIN_DIR="/opt/llvm-mingw"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          sudo rm -rf "$TOOLCHAIN_DIR"
          sudo mkdir -p "$TOOLCHAIN_DIR"
          sudo tar -C "$TOOLCHAIN_DIR" --strip-components=1 -xJf llvm.tar.xz
          echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

      - name: Checkout VKD3D
        uses: actions/checkout@v4
        with:
          repository: HansKristian-Work/vkd3d-proton
          submodules: recursive
          fetch-depth: 0
          path: src

      - name: Generate Version Name
        run: |
          cd src
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "VERSION_NAME=3.0b-${COMMIT_HASH}" >> $GITHUB_ENV

      - name: Build Standard
        run: |
          cat <<EOF > cross-x64.txt
          [binaries]
          c = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-clang'
          cpp = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-clang++'
          ar = '/opt/llvm-mingw/bin/llvm-ar'
          strip = '/opt/llvm-mingw/bin/llvm-strip'
          windres = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-windres'
          widl = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          exe_wrapper = ['wine']
          [host_machine]
          system = 'windows'
          cpu_family = 'x86_64'
          cpu = 'x86_64'
          endian = 'little'
          EOF

          cat <<EOF > cross-x86.txt
          [binaries]
          c = '/opt/llvm-mingw/bin/i686-w64-mingw32-clang'
          cpp = '/opt/llvm-mingw/bin/i686-w64-mingw32-clang++'
          ar = '/opt/llvm-mingw/bin/llvm-ar'
          strip = '/opt/llvm-mingw/bin/llvm-strip'
          windres = '/opt/llvm-mingw/bin/i686-w64-mingw32-windres'
          widl = '/opt/llvm-mingw/bin/i686-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          exe_wrapper = ['wine']
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

          cd src
          meson setup build-x64 --cross-file ../cross-x64.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-x64
          meson setup build-x86 --cross-file ../cross-x86.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-x86

      - name: Package Standard
        run: |
          rm -rf pkg_std
          mkdir -p pkg_std/system32 pkg_std/syswow64
          cp src/build-x64/libs/d3d12/d3d12.dll pkg_std/system32/
          cp src/build-x64/libs/d3d12/d3d12core.dll pkg_std/system32/
          cp src/build-x86/libs/d3d12/d3d12.dll pkg_std/syswow64/
          cp src/build-x86/libs/d3d12/d3d12core.dll pkg_std/syswow64/
          
          echo "{\"type\": \"VKD3D\", \"versionName\": \"${{ env.VERSION_NAME }}\", \"versionCode\": 0, \"description\": \"vkd3d-proton Nightly Standard\", \"files\": [{\"source\": \"system32/d3d12.dll\", \"target\": \"\${system32}/d3d12.dll\"}, {\"source\": \"system32/d3d12core.dll\", \"target\": \"\${system32}/d3d12core.dll\"}, {\"source\": \"syswow64/d3d12.dll\", \"target\": \"\${syswow64}/d3d12.dll\"}, {\"source\": \"syswow64/d3d12core.dll\", \"target\": \"\${syswow64}/d3d12core.dll\"}]}" > pkg_std/profile.json
          
          cd pkg_std && tar -cJf ../VKD3D-Standard-${{ env.VERSION_NAME }}.wcp *

      - name: Upload Standard
        uses: actions/upload-artifact@v4
        with:
          name: VKD3D-Standard
          path: '*.wcp'


  # ==================================================================
  # JOB 2: ARM OPTIMIZED (NOW WITH SYSWOW64 INCLUDED)
  # ==================================================================
  build-arm-optimized:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install Dependencies
        run: |
          pacman -Sy --noconfirm git base-devel glslang python python-pip cmake ninja jq wget tar zstd llvm

      - name: Checkout VKD3D
        uses: actions/checkout@v4
        with:
          repository: HansKristian-Work/vkd3d-proton
          submodules: recursive
          path: src

      - name: Setup Toolchain (Arihany 20251104)
        run: |
          python -m venv .venv
          .venv/bin/python -m pip install "meson==1.2.3" "ninja==1.11.1"
          LLVM_TAG="20251104"
          TOOLCHAIN="/opt/llvm-mingw"
          mkdir -p "$TOOLCHAIN"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_TAG/llvm-mingw-$LLVM_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          tar -C "$TOOLCHAIN" --strip-components=1 -xJf llvm.tar.xz
          echo "$TOOLCHAIN/bin" >> $GITHUB_PATH
          echo "$PWD/.venv/bin" >> $GITHUB_PATH

      - name: Build & Stage (Static Link ARM64EC + x86)
        run: |
          # 1. ARM64EC (Hybrid for system32)
          cat <<EOF > arm.ini
          [binaries]
          c = 'arm64ec-w64-mingw32-gcc'
          cpp = 'arm64ec-w64-mingw32-g++'
          ar = 'arm64ec-w64-mingw32-ar'
          strip = '/opt/llvm-mingw/bin/llvm-strip'
          windres = 'arm64ec-w64-mingw32-windres'
          widl = 'arm64ec-w64-mingw32-widl'
          [built-in options]
          c_link_args = ['-static', '-static-libgcc', '-static-libstdc++']
          cpp_link_args = ['-static', '-static-libgcc', '-static-libstdc++']
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

          # 2. x86 (Standard 32-bit for syswow64 - REQUIRED)
          cat <<EOF > x86.ini
          [binaries]
          c = 'i686-w64-mingw32-gcc'
          cpp = 'i686-w64-mingw32-g++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'i686-w64-mingw32-windres'
          widl = 'i686-w64-mingw32-widl'
          [built-in options]
          c_link_args = ['-static', '-static-libgcc', '-static-libstdc++']
          cpp_link_args = ['-static', '-static-libgcc', '-static-libstdc++']
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

          cd src
          # Build ARM64EC (System32)
          meson setup build_arm --cross-file ../arm.ini --buildtype release --prefix "$PWD/stage/arm" -Dstrip=true
          ninja -C build_arm install

          # Build x86 (SysWoW64)
          meson setup build_x86 --cross-file ../x86.ini --buildtype release --prefix "$PWD/stage/x86" -Dstrip=true
          ninja -C build_x86 install

      - name: Generate Version Name
        run: |
          cd src
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "VERSION_NAME=3.0b-ARM64EC-${COMMIT_HASH}" >> $GITHUB_ENV

      - name: Binary Patch (Arihany 0xAA64 Spoof)
        run: |
          # Patch ONLY the ARM64EC files in system32. 
          # The x86 files in syswow64 must remain standard x86.
          for dll in src/stage/arm/bin/*.dll; do
             python3 -c "import sys; f=open(sys.argv[1], 'r+b'); f.seek(0x3C); pe=int.from_bytes(f.read(4), 'little'); f.seek(pe+4); f.write(b'\x64\xaa'); f.close()" "$dll"
          done

      - name: Package Optimized
        run: |
          rm -rf pkg_arm
          mkdir -p pkg_arm/system32 pkg_arm/syswow64
          
          # Copy ARM64EC files to system32
          cp src/stage/arm/bin/*.dll pkg_arm/system32/
          
          # Copy x86 files to syswow64 (THIS WAS MISSING!)
          cp src/stage/x86/bin/*.dll pkg_arm/syswow64/
          
          # Correct JSON with ALL 4 files + Descriptions
          echo "{\"type\": \"VKD3D\", \"versionName\": \"${{ env.VERSION_NAME }}\", \"versionCode\": 0, \"description\": \"vkd3d-proton FEX Optimized (Complete)\", \"files\": [{\"source\": \"system32/d3d12.dll\", \"target\": \"\${system32}/d3d12.dll\"}, {\"source\": \"system32/d3d12core.dll\", \"target\": \"\${system32}/d3d12core.dll\"}, {\"source\": \"syswow64/d3d12.dll\", \"target\": \"\${syswow64}/d3d12.dll\"}, {\"source\": \"syswow64/d3d12core.dll\", \"target\": \"\${syswow64}/d3d12core.dll\"}]}" > pkg_arm/profile.json
          
          cd pkg_arm && tar -cJf ../vk3dk-Arm64ec.wcp *

      - name: Upload ARM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vk3dk-Arm64ec
          path: '*.wcp'
