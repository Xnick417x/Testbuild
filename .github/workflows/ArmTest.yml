name: Build VKD3D-Proton (ARM64EC Standalone)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 17 * * *"

jobs:
  build-arm64ec:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update -y
          # Added 'unzip' and 'zstd' explicitly as seen in his script
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl xz-utils jq git \
            build-essential python3 python3-pip pkg-config \
            meson ninja-build zstd wget unzip

          python3 -m pip install --upgrade pip
          python3 -m pip install meson

      - name: Setup GLSLang (Critical Match)
        run: |
          # He uses the master-tot release manually, so we do too.
          wget -q https://github.com/KhronosGroup/glslang/releases/download/master-tot/glslang-master-linux-Release.zip
          unzip -q glslang-master-linux-Release.zip -d glslang
          echo "$PWD/glslang/bin" >> $GITHUB_PATH

      - name: Setup Toolchain (llvm-mingw)
        run: |
          LLVM_MINGW_TAG="20251104"
          TOOLCHAIN_DIR="/opt/llvm-mingw"
          
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          
          sudo rm -rf "$TOOLCHAIN_DIR"
          sudo mkdir -p "$TOOLCHAIN_DIR"
          sudo tar -C "$TOOLCHAIN_DIR" --strip-components=1 -xJf llvm.tar.xz
          
          echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

      - name: Checkout VKD3D-Proton
        uses: actions/checkout@v4
        with:
          repository: HansKristian-Work/vkd3d-proton
          submodules: recursive
          fetch-depth: 0
          path: src

      - name: Generate Version Info
        id: version
        run: |
          cd src
          COMMIT_HASH=$(git rev-parse --short HEAD)
          VERSION_NAME="3.0b-ARM64EC-${COMMIT_HASH}"
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV

      - name: Build ARM64EC & x86
        run: |
          # 1. ARM64EC: Matches his 'arm64ec.txt' exactly (Clang, no extra static flags)
          cat <<EOF > arm64ec.txt
          [binaries]
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'arm64ec-w64-mingw32-windres'
          widl = 'arm64ec-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

          # 2. x86: Matches his 'x86.txt' exactly (Clang, no extra static flags)
          cat <<EOF > x86.txt
          [binaries]
          c = 'i686-w64-mingw32-clang'
          cpp = 'i686-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'i686-w64-mingw32-windres'
          widl = 'i686-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

          cd src
          
          # He uses -Dstrip=true here, so we do too
          meson setup build-ec --cross-file ../arm64ec.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-ec

          meson setup build-x86 --cross-file ../x86.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-x86

      - name: Package Artifacts
        run: |
          rm -rf final_package
          mkdir -p final_package/system32
          mkdir -p final_package/syswow64

          # His script uses find -name "file" -exec cp ...
          find src/build-ec -name "d3d12.dll" -exec cp -L {} final_package/system32/ \;
          find src/build-ec -name "d3d12core.dll" -exec cp -L {} final_package/system32/ \;
          find src/build-x86 -name "d3d12.dll" -exec cp -L {} final_package/syswow64/ \;
          find src/build-x86 -name "d3d12core.dll" -exec cp -L {} final_package/syswow64/ \;

          # Explicit Strip (He does this manually at the end)
          llvm-strip --strip-all final_package/system32/*.dll
          llvm-strip --strip-all final_package/syswow64/*.dll

          # JSON: Matches his exactly (using env var for version)
          cat <<EOF > final_package/profile.json
          {
            "type": "VKD3D",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": 0,
            "description": "Vk3dk-Proton ${{ env.VERSION_NAME }} nightly",
            "files": [
              {
                "source": "system32/d3d12.dll",
                "target": "\${system32}/d3d12.dll"
              },
              {
                "source": "system32/d3d12core.dll",
                "target": "\${system32}/d3d12core.dll"
              },
              {
                "source": "syswow64/d3d12.dll",
                "target": "\${syswow64}/d3d12.dll"
              },
              {
                "source": "syswow64/d3d12core.dll",
                "target": "\${syswow64}/d3d12core.dll"
              }
            ]
          }
          EOF

          cd final_package
          
          # THE FIX: Use ZSTD compression directly on the files
          # 'tar --zstd' creates a .tar.zst archive, which is what Winlator likely wants for .wcp
          tar --zstd -cf ../VKD3D-Proton-${{ env.VERSION_NAME }}.wcp *

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vkd3d-arm64ec
          path: '*.wcp'
