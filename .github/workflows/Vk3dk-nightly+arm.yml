name: Build VKD3D-Proton Nightly

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-vkd3d:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y gcc-mingw-w64-x86-64 gcc-mingw-w64-i686 \
            g++-mingw-w64-x86-64 g++-mingw-w64-i686 \
            meson ninja-build glslang-tools wine wine32 wine64 \
            wget curl jq git

      - name: Fetch Latest VKD3D-Proton Commit
        id: fetch_commit
        run: |
          LATEST_COMMIT=$(curl -s https://api.github.com/repos/HansKristian-Work/vkd3d-proton/commits/master | jq -r .sha)
          SHORT_COMMIT=$(echo $LATEST_COMMIT | cut -c1-8)
          echo "COMMIT_HASH=$SHORT_COMMIT" >> $GITHUB_ENV
          echo "VK3DK_VER=3.0b-$SHORT_COMMIT" >> $GITHUB_ENV

      - name: Clone VKD3D-Proton Source
        run: |
          git clone --recursive https://github.com/HansKristian-Work/vkd3d-proton.git vkd3d-proton
          cd vkd3d-proton
          git checkout ${{ env.COMMIT_HASH }}

      - name: Build Standard VKD3D-Proton
        run: |
          cd vkd3d-proton
          ./package-release.sh vkd3d-built --no-package

      - name: Build ARM64EC VKD3D-Proton
        run: |
          cd vkd3d-proton
          ./package-release.sh vkd3d-built-arm64ec --no-package --arm64ec

      - name: Create temp directories for packaging
        run: |
          mkdir -p temp_packaging/system32 temp_packaging/syswow64
          mkdir -p temp_packaging_arm64ec/system32 temp_packaging_arm64ec/syswow64

      - name: Copy Standard DLLs
        run: |
          cp vkd3d-proton/vkd3d-built/*/x64/d3d12*.dll temp_packaging/system32/
          cp vkd3d-proton/vkd3d-built/*/x86/d3d12*.dll temp_packaging/syswow64/

      - name: Copy ARM64EC DLLs
        run: |
          cp vkd3d-proton/vkd3d-built-arm64ec/*/arm64ec/d3d12*.dll temp_packaging_arm64ec/system32/
          cp vkd3d-proton/vkd3d-built-arm64ec/*/x86/d3d12*.dll temp_packaging_arm64ec/syswow64/

      - name: Create profile.json for Standard Build
        run: |
          cat <<EOF > temp_packaging/profile.json
          {
            "type": "VKD3D",
            "versionName": "${{ env.VK3DK_VER }}",
            "versionCode": 0,
            "description": "VK3DK Nightly Build",
            "files": [
              { "source": "system32/d3d12.dll", "target": "\${system32}/d3d12.dll" },
              { "source": "system32/d3d12core.dll", "target": "\${system32}/d3d12core.dll" },
              { "source": "syswow64/d3d12.dll", "target": "\${syswow64}/d3d12.dll" },
              { "source": "syswow64/d3d12core.dll", "target": "\${syswow64}/d3d12core.dll" }
            ]
          }
          EOF

      - name: Package Standard Build into .wcp
        run: |
          cd temp_packaging
          tar -cJf ../Vk3dk-Standard-${{ env.VK3DK_VER }}.wcp *

      - name: Create profile.json for ARM64EC Build
        run: |
          cat <<EOF > temp_packaging_arm64ec/profile.json
          {
            "type": "VKD3D",
            "versionName": "${{ env.VK3DK_VER }}-arm64ec",
            "versionCode": 0,
            "description": "VK3DK ARM64EC Nightly Build",
            "files": [
              { "source": "system32/d3d12.dll", "target": "\${system32}/d3d12.dll" },
              { "source": "system32/d3d12core.dll", "target": "\${system32}/d3d12core.dll" },
              { "source": "syswow64/d3d12.dll", "target": "\${syswow64}/d3d12.dll" },
              { "source": "syswow64/d3d12core.dll", "target": "\${syswow64}/d3d12core.dll" }
            ]
          }
          EOF

      - name: Package ARM64EC Build into .wcp
        run: |
          cd temp_packaging_arm64ec
          tar -cJf ../Vk3dk-Arm64ec-${{ env.VK3DK_VER }}-arm64ec.wcp *

      - name: Upload Standard Nightly Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: vk3dk-nightly-${{ env.COMMIT_HASH }}
          files: Vk3dk-Standard-${{ env.VK3DK_VER }}.wcp
          name: "VKD3D-Proton Nightly ${{ env.COMMIT_HASH }}"
          body: "Automated nightly build of VKD3D-Proton (Standard)."
          make_latest: true

      - name: Upload ARM64EC Nightly Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: vk3dk-arm64ec-nightly-${{ env.COMMIT_HASH }}
          files: Vk3dk-Arm64ec-${{ env.VK3DK_VER }}-arm64ec.wcp
          name: "VKD3D-Proton ARM64EC Nightly ${{ env.COMMIT_HASH }}"
          body: "Automated nightly build of VKD3D-Proton (ARM64EC)."
          make_latest: true
